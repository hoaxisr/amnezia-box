name: Build AWG

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g., 1.13.0-alpha.36)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: linux-amd64
            goos: linux
            goarch: amd64
          - name: entware-mipsel
            goos: linux
            goarch: mipsle
            gomips: softfloat
          - name: entware-aarch64
            goos: linux
            goarch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.24

      - name: Vendor dependencies and apply patches
        run: |
          go mod vendor
          if [ -x "./patches/amneziawg-go/apply.sh" ]; then
            echo "Applying AWG patches..."
            ./patches/amneziawg-go/apply.sh
          else
            echo "No patches to apply"
          fi

      - name: Build
        run: |
          mkdir -p dist
          OUTPUT_NAME="sing-box-${{ inputs.version }}-awg2.0-${{ matrix.name }}"

          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} GOMIPS=${{ matrix.gomips }} \
          go build -v -trimpath -o "dist/${OUTPUT_NAME}" \
            -tags "with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_awg" \
            -ldflags "-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ inputs.version }}-awg2.0" \
            ./cmd/sing-box
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="v${{ inputs.version }}-awg2.0"

          # Delete existing release if exists
          gh release delete "${VERSION}" --yes --repo ${{ github.repository }} 2>/dev/null || true

          # Create release notes
          cat > notes.md << 'EOF'
          ## sing-box with AWG 2.0 support

          ### AWG 2.0 Features:
          - H1-H4 ranges support
          - S3, S4 padding parameters
          - I1-I5 obfuscation chains

          ### Platforms:
          - linux-amd64
          - entware-mipsel (softfloat)
          - entware-aarch64
          EOF

          # Create release
          PRERELEASE_FLAG=""
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "${VERSION}" \
            --repo ${{ github.repository }} \
            --title "${VERSION}" \
            ${PRERELEASE_FLAG} \
            --notes-file notes.md \
            dist/*
