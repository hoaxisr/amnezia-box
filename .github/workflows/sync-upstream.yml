name: Sync with upstream sing-box

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if already up to date'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      upstream_sha: ${{ steps.check.outputs.upstream_sha }}
      upstream_version: ${{ steps.check.outputs.upstream_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/SagerNet/sing-box.git || true
          git fetch upstream --tags

      - name: Check for updates
        id: check
        run: |
          UPSTREAM_SHA=$(git rev-parse upstream/dev-next)
          UPSTREAM_VERSION=$(git describe --tags upstream/dev-next 2>/dev/null || echo "unknown")

          # Check if we have this commit in our history
          if git merge-base --is-ancestor $UPSTREAM_SHA dev-next 2>/dev/null; then
            echo "Already up to date with upstream"
            if [ "${{ inputs.force_sync }}" != "true" ]; then
              echo "has_updates=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT

          # Show what's new
          echo "## New commits from upstream:" >> $GITHUB_STEP_SUMMARY
          git log --oneline dev-next..upstream/dev-next | head -20 >> $GITHUB_STEP_SUMMARY

  sync:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/SagerNet/sing-box.git || true
          git fetch upstream --tags

      - name: Export AWG patches
        run: |
          mkdir -p patches/awg
          # Export commits from dev-next to feature/awg
          git format-patch dev-next..feature/awg -o patches/awg --numbered
          echo "Exported $(ls patches/awg | wc -l) AWG patches"
          ls -la patches/awg/

      - name: Update dev-next from upstream
        run: |
          git checkout dev-next
          git merge upstream/dev-next --no-edit || {
            echo "::warning::Merge conflicts in dev-next, manual intervention required"
            git merge --abort
            exit 1
          }

      - name: Rebase feature/awg
        id: rebase
        run: |
          git checkout feature/awg
          git rebase dev-next || {
            echo "conflicts=true" >> $GITHUB_OUTPUT
            git rebase --abort
            exit 0
          }
          echo "conflicts=false" >> $GITHUB_OUTPUT

      - name: Create sync branch
        if: steps.rebase.outputs.conflicts != 'true'
        run: |
          BRANCH_NAME="sync/upstream-${{ github.run_number }}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Push changes
        if: steps.rebase.outputs.conflicts != 'true'
        run: |
          git push origin dev-next
          git push origin ${{ env.branch_name }}

      - name: Create Pull Request
        if: steps.rebase.outputs.conflicts != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          base: feature/awg
          title: "â¬†ï¸ Sync with upstream sing-box ${{ needs.check-upstream.outputs.upstream_version }}"
          body: |
            ## Upstream Sync

            This PR syncs with the latest upstream sing-box changes.

            **Upstream version:** ${{ needs.check-upstream.outputs.upstream_version }}
            **Upstream commit:** ${{ needs.check-upstream.outputs.upstream_sha }}

            ### Changes from upstream
            ```
            $(git log --oneline feature/awg..dev-next | head -20)
            ```

            ### AWG patches preserved
            All AWG-specific commits have been rebased on top of the new upstream.

            ### Checklist
            - [ ] Build passes
            - [ ] AWG functionality works correctly
            - [ ] No regressions in existing features

            ---
            ðŸ¤– This PR was automatically created by the sync-upstream workflow.
          labels: |
            upstream-sync
            automated

      - name: Create conflict issue
        if: steps.rebase.outputs.conflicts == 'true'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "âš ï¸ Upstream sync requires manual intervention"
          content-filepath: .github/ISSUE_TEMPLATE/sync-conflict.md
          labels: |
            upstream-sync
            needs-attention

  notify:
    needs: [check-upstream, sync]
    if: always() && needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.sync.result }}" == "success" ]; then
            echo "âœ… Successfully synced with upstream sing-box" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Sync completed with issues - check the workflow logs" >> $GITHUB_STEP_SUMMARY
          fi
