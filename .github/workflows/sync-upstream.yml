name: Sync with upstream sing-box

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to sync'
        required: true
        default: 'alpha'
        type: choice
        options:
          - alpha
          - main
      force_sync:
        description: 'Force sync even if already up to date'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      upstream_sha: ${{ steps.check.outputs.upstream_sha }}
      upstream_version: ${{ steps.check.outputs.upstream_version }}
      upstream_branch: ${{ steps.check.outputs.upstream_branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'alpha' }}
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/SagerNet/sing-box.git || true
          git fetch upstream --tags

      - name: Check for updates
        id: check
        run: |
          TARGET_BRANCH="${{ inputs.branch || 'alpha' }}"

          # Determine upstream branch based on target
          if [ "$TARGET_BRANCH" = "alpha" ]; then
            UPSTREAM_BRANCH="dev-next"
          else
            UPSTREAM_BRANCH="stable-next"
          fi

          UPSTREAM_SHA=$(git rev-parse upstream/$UPSTREAM_BRANCH)
          UPSTREAM_VERSION=$(git describe --tags upstream/$UPSTREAM_BRANCH 2>/dev/null || echo "unknown")

          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT

          # Check if we have this commit in our history
          if git merge-base --is-ancestor $UPSTREAM_SHA $TARGET_BRANCH 2>/dev/null; then
            echo "Already up to date with upstream"
            if [ "${{ inputs.force_sync }}" != "true" ]; then
              echo "has_updates=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT

          # Show what's new
          echo "## New commits from upstream ($UPSTREAM_BRANCH):" >> $GITHUB_STEP_SUMMARY
          git log --oneline $TARGET_BRANCH..upstream/$UPSTREAM_BRANCH | head -20 >> $GITHUB_STEP_SUMMARY

  sync:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'alpha' }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/SagerNet/sing-box.git || true
          git fetch upstream --tags

      - name: Sync with upstream
        id: sync
        run: |
          TARGET_BRANCH="${{ inputs.branch || 'alpha' }}"
          UPSTREAM_BRANCH="${{ needs.check-upstream.outputs.upstream_branch }}"

          # Create sync branch from upstream
          SYNC_BRANCH="sync/upstream-${{ github.run_number }}"
          git checkout -b $SYNC_BRANCH upstream/$UPSTREAM_BRANCH

          # Get AWG patches from current branch
          git format-patch $TARGET_BRANCH --stdout > /tmp/awg-patches.patch || true

          # Try to apply AWG patches
          if [ -s /tmp/awg-patches.patch ]; then
            # We need patches from our branch, not reverse
            git checkout $TARGET_BRANCH
            mkdir -p /tmp/patches
            # Export AWG-specific commits (after base upstream)
            MERGE_BASE=$(git merge-base $TARGET_BRANCH upstream/$UPSTREAM_BRANCH 2>/dev/null || echo "")
            if [ -n "$MERGE_BASE" ]; then
              git format-patch $MERGE_BASE..$TARGET_BRANCH -o /tmp/patches --numbered
            else
              # If no common base, export all commits as patches
              git format-patch --root $TARGET_BRANCH -o /tmp/patches --numbered
            fi

            git checkout $SYNC_BRANCH

            # Apply patches
            if ls /tmp/patches/*.patch 1>/dev/null 2>&1; then
              for patch in /tmp/patches/*.patch; do
                git am --3way "$patch" || {
                  echo "conflicts=true" >> $GITHUB_OUTPUT
                  git am --abort
                  exit 0
                }
              done
            fi
          fi

          echo "conflicts=false" >> $GITHUB_OUTPUT
          echo "sync_branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT

      - name: Push sync branch
        if: steps.sync.outputs.conflicts != 'true'
        run: |
          git push origin ${{ steps.sync.outputs.sync_branch }}

      - name: Create Pull Request
        if: steps.sync.outputs.conflicts != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.sync.outputs.sync_branch }}
          base: ${{ inputs.branch || 'alpha' }}
          title: "Sync with upstream sing-box ${{ needs.check-upstream.outputs.upstream_version }}"
          body: |
            ## Upstream Sync

            This PR syncs with the latest upstream sing-box changes.

            **Target branch:** ${{ inputs.branch || 'alpha' }}
            **Upstream branch:** ${{ needs.check-upstream.outputs.upstream_branch }}
            **Upstream version:** ${{ needs.check-upstream.outputs.upstream_version }}
            **Upstream commit:** ${{ needs.check-upstream.outputs.upstream_sha }}

            ### AWG patches preserved
            All AWG-specific commits have been rebased on top of the new upstream.

            ### Checklist
            - [ ] Build passes
            - [ ] AWG functionality works correctly
            - [ ] No regressions in existing features

            ---
            This PR was automatically created by the sync-upstream workflow.
          labels: |
            upstream-sync
            automated

      - name: Create conflict issue
        if: steps.sync.outputs.conflicts == 'true'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Upstream sync requires manual intervention (${{ inputs.branch || 'alpha' }})"
          content-filepath: .github/ISSUE_TEMPLATE/sync-conflict.md
          labels: |
            upstream-sync
            needs-attention

  notify:
    needs: [check-upstream, sync]
    if: always() && needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.sync.result }}" == "success" ]; then
            echo "Successfully synced with upstream sing-box" >> $GITHUB_STEP_SUMMARY
          else
            echo "Sync completed with issues - check the workflow logs" >> $GITHUB_STEP_SUMMARY
          fi
