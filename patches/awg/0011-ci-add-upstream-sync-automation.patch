From e52a94735740147052c5b0b406b9a0a3d02d7d87 Mon Sep 17 00:00:00 2001
From: hoaxisr <avs@rusimp.com>
Date: Mon, 29 Dec 2025 11:23:17 +0000
Subject: [PATCH 11/12] ci: add upstream sync automation
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Add GitHub Actions workflow for weekly upstream sync checks
- Add Makefile commands for local sync workflow:
  - sync-check: Check for new upstream commits
  - sync-full: Full sync (update dev-next + rebase AWG)
  - export-patches: Backup AWG commits as patch files
  - apply-patches: Restore from backup if needed

Workflow:
  1. make sync-check       # See what's new
  2. make export-patches   # Backup patches
  3. make sync-full        # Sync and rebase
  4. make build            # Verify build works

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
---
 .github/workflows/sync-upstream.yml | 177 ++++++++++++++++++++++++++++
 Makefile                            | 115 ++++++++++++++++++
 2 files changed, 292 insertions(+)
 create mode 100644 .github/workflows/sync-upstream.yml

diff --git a/.github/workflows/sync-upstream.yml b/.github/workflows/sync-upstream.yml
new file mode 100644
index 00000000..7abcc310
--- /dev/null
+++ b/.github/workflows/sync-upstream.yml
@@ -0,0 +1,177 @@
+name: Sync with upstream sing-box
+
+on:
+  schedule:
+    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
+  workflow_dispatch:
+    inputs:
+      force_sync:
+        description: 'Force sync even if already up to date'
+        required: false
+        default: 'false'
+        type: boolean
+
+permissions:
+  contents: write
+  pull-requests: write
+
+jobs:
+  check-upstream:
+    runs-on: ubuntu-latest
+    outputs:
+      has_updates: ${{ steps.check.outputs.has_updates }}
+      upstream_sha: ${{ steps.check.outputs.upstream_sha }}
+      upstream_version: ${{ steps.check.outputs.upstream_version }}
+    steps:
+      - uses: actions/checkout@v4
+        with:
+          fetch-depth: 0
+
+      - name: Add upstream remote
+        run: |
+          git remote add upstream https://github.com/SagerNet/sing-box.git || true
+          git fetch upstream --tags
+
+      - name: Check for updates
+        id: check
+        run: |
+          UPSTREAM_SHA=$(git rev-parse upstream/dev-next)
+          UPSTREAM_VERSION=$(git describe --tags upstream/dev-next 2>/dev/null || echo "unknown")
+
+          # Check if we have this commit in our history
+          if git merge-base --is-ancestor $UPSTREAM_SHA dev-next 2>/dev/null; then
+            echo "Already up to date with upstream"
+            if [ "${{ inputs.force_sync }}" != "true" ]; then
+              echo "has_updates=false" >> $GITHUB_OUTPUT
+              exit 0
+            fi
+          fi
+
+          echo "has_updates=true" >> $GITHUB_OUTPUT
+          echo "upstream_sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
+          echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
+
+          # Show what's new
+          echo "## New commits from upstream:" >> $GITHUB_STEP_SUMMARY
+          git log --oneline dev-next..upstream/dev-next | head -20 >> $GITHUB_STEP_SUMMARY
+
+  sync:
+    needs: check-upstream
+    if: needs.check-upstream.outputs.has_updates == 'true'
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+        with:
+          fetch-depth: 0
+          token: ${{ secrets.GITHUB_TOKEN }}
+
+      - name: Configure git
+        run: |
+          git config user.name "github-actions[bot]"
+          git config user.email "github-actions[bot]@users.noreply.github.com"
+
+      - name: Add upstream remote
+        run: |
+          git remote add upstream https://github.com/SagerNet/sing-box.git || true
+          git fetch upstream --tags
+
+      - name: Export AWG patches
+        run: |
+          mkdir -p patches/awg
+          # Export commits from dev-next to feature/awg
+          git format-patch dev-next..feature/awg -o patches/awg --numbered
+          echo "Exported $(ls patches/awg | wc -l) AWG patches"
+          ls -la patches/awg/
+
+      - name: Update dev-next from upstream
+        run: |
+          git checkout dev-next
+          git merge upstream/dev-next --no-edit || {
+            echo "::warning::Merge conflicts in dev-next, manual intervention required"
+            git merge --abort
+            exit 1
+          }
+
+      - name: Rebase feature/awg
+        id: rebase
+        run: |
+          git checkout feature/awg
+          git rebase dev-next || {
+            echo "conflicts=true" >> $GITHUB_OUTPUT
+            git rebase --abort
+            exit 0
+          }
+          echo "conflicts=false" >> $GITHUB_OUTPUT
+
+      - name: Create sync branch
+        if: steps.rebase.outputs.conflicts != 'true'
+        run: |
+          BRANCH_NAME="sync/upstream-${{ github.run_number }}"
+          git checkout -b $BRANCH_NAME
+          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
+
+      - name: Push changes
+        if: steps.rebase.outputs.conflicts != 'true'
+        run: |
+          git push origin dev-next
+          git push origin ${{ env.branch_name }}
+
+      - name: Create Pull Request
+        if: steps.rebase.outputs.conflicts != 'true'
+        uses: peter-evans/create-pull-request@v5
+        with:
+          token: ${{ secrets.GITHUB_TOKEN }}
+          branch: ${{ env.branch_name }}
+          base: feature/awg
+          title: "‚¨ÜÔ∏è Sync with upstream sing-box ${{ needs.check-upstream.outputs.upstream_version }}"
+          body: |
+            ## Upstream Sync
+
+            This PR syncs with the latest upstream sing-box changes.
+
+            **Upstream version:** ${{ needs.check-upstream.outputs.upstream_version }}
+            **Upstream commit:** ${{ needs.check-upstream.outputs.upstream_sha }}
+
+            ### Changes from upstream
+            ```
+            $(git log --oneline feature/awg..dev-next | head -20)
+            ```
+
+            ### AWG patches preserved
+            All AWG-specific commits have been rebased on top of the new upstream.
+
+            ### Checklist
+            - [ ] Build passes
+            - [ ] AWG functionality works correctly
+            - [ ] No regressions in existing features
+
+            ---
+            ü§ñ This PR was automatically created by the sync-upstream workflow.
+          labels: |
+            upstream-sync
+            automated
+
+      - name: Create conflict issue
+        if: steps.rebase.outputs.conflicts == 'true'
+        uses: peter-evans/create-issue-from-file@v4
+        with:
+          title: "‚ö†Ô∏è Upstream sync requires manual intervention"
+          content-filepath: .github/ISSUE_TEMPLATE/sync-conflict.md
+          labels: |
+            upstream-sync
+            needs-attention
+
+  notify:
+    needs: [check-upstream, sync]
+    if: always() && needs.check-upstream.outputs.has_updates == 'true'
+    runs-on: ubuntu-latest
+    steps:
+      - name: Summary
+        run: |
+          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
+          echo "" >> $GITHUB_STEP_SUMMARY
+          if [ "${{ needs.sync.result }}" == "success" ]; then
+            echo "‚úÖ Successfully synced with upstream sing-box" >> $GITHUB_STEP_SUMMARY
+          else
+            echo "‚ö†Ô∏è Sync completed with issues - check the workflow logs" >> $GITHUB_STEP_SUMMARY
+          fi
diff --git a/Makefile b/Makefile
index 8951aaf6..c1f924e2 100644
--- a/Makefile
+++ b/Makefile
@@ -270,3 +270,118 @@ update:
 	git fetch
 	git reset FETCH_HEAD --hard
 	git clean -fdx
+
+# =============================================================================
+# Upstream Sync Commands
+# =============================================================================
+
+UPSTREAM_REPO = https://github.com/SagerNet/sing-box.git
+UPSTREAM_BRANCH = dev-next
+AWG_BRANCH = feature/awg
+PATCHES_DIR = patches/awg
+
+.PHONY: sync-setup sync-check sync-upstream sync-rebase export-patches apply-patches sync-full
+
+# Initial setup: add upstream remote
+sync-setup:
+	@git remote add upstream $(UPSTREAM_REPO) 2>/dev/null || true
+	@git fetch upstream
+	@echo "‚úÖ Upstream remote configured"
+
+# Check for new upstream commits
+sync-check: sync-setup
+	@echo "üìä Checking upstream status..."
+	@echo ""
+	@echo "Local $(UPSTREAM_BRANCH):"
+	@git log --oneline -1 $(UPSTREAM_BRANCH) 2>/dev/null || echo "  (branch not found)"
+	@echo ""
+	@echo "Upstream $(UPSTREAM_BRANCH):"
+	@git log --oneline -1 upstream/$(UPSTREAM_BRANCH)
+	@echo ""
+	@echo "New commits from upstream:"
+	@git log --oneline $(UPSTREAM_BRANCH)..upstream/$(UPSTREAM_BRANCH) 2>/dev/null | head -15 || echo "  (none or branch missing)"
+	@echo ""
+	@BEHIND=$$(git rev-list --count $(UPSTREAM_BRANCH)..upstream/$(UPSTREAM_BRANCH) 2>/dev/null || echo "?"); \
+	echo "Status: $$BEHIND commits behind upstream"
+
+# Export AWG patches for backup/review
+export-patches:
+	@echo "üì¶ Exporting AWG patches..."
+	@rm -rf $(PATCHES_DIR)
+	@mkdir -p $(PATCHES_DIR)
+	@git format-patch $(UPSTREAM_BRANCH)..$(AWG_BRANCH) -o $(PATCHES_DIR) --numbered 2>/dev/null || \
+		git format-patch origin/$(UPSTREAM_BRANCH)..$(AWG_BRANCH) -o $(PATCHES_DIR) --numbered
+	@echo "‚úÖ Exported $$(ls $(PATCHES_DIR) 2>/dev/null | wc -l) patches to $(PATCHES_DIR)/"
+	@ls -la $(PATCHES_DIR)/ 2>/dev/null || true
+
+# Update dev-next from upstream (fast-forward merge)
+sync-upstream: sync-setup
+	@echo "‚¨áÔ∏è Syncing $(UPSTREAM_BRANCH) with upstream..."
+	@git checkout $(UPSTREAM_BRANCH)
+	@git merge upstream/$(UPSTREAM_BRANCH) --ff-only || { \
+		echo "‚ö†Ô∏è Fast-forward not possible. Run: git merge upstream/$(UPSTREAM_BRANCH)"; \
+		exit 1; \
+	}
+	@echo "‚úÖ $(UPSTREAM_BRANCH) updated"
+
+# Rebase AWG branch on top of updated dev-next
+sync-rebase: export-patches
+	@echo "üîÑ Rebasing $(AWG_BRANCH) onto $(UPSTREAM_BRANCH)..."
+	@git checkout $(AWG_BRANCH)
+	@git rebase $(UPSTREAM_BRANCH) || { \
+		echo ""; \
+		echo "‚ö†Ô∏è Rebase conflicts detected!"; \
+		echo ""; \
+		echo "To resolve:"; \
+		echo "  1. Fix conflicts in the listed files"; \
+		echo "  2. git add <fixed-files>"; \
+		echo "  3. git rebase --continue"; \
+		echo ""; \
+		echo "To abort: git rebase --abort"; \
+		echo ""; \
+		echo "Patches are backed up in $(PATCHES_DIR)/"; \
+		exit 1; \
+	}
+	@echo "‚úÖ Rebase complete"
+
+# Apply patches from backup (emergency recovery)
+apply-patches:
+	@echo "üì• Applying patches from $(PATCHES_DIR)/..."
+	@git am $(PATCHES_DIR)/*.patch || { \
+		echo "‚ö†Ô∏è Patch application failed"; \
+		echo "Run 'git am --abort' to undo, then fix manually"; \
+		exit 1; \
+	}
+	@echo "‚úÖ Patches applied"
+
+# Full sync: update dev-next and rebase AWG branch
+sync-full: sync-upstream sync-rebase
+	@echo ""
+	@echo "üéâ Full sync complete!"
+	@echo ""
+	@git log --oneline $(UPSTREAM_BRANCH)..$(AWG_BRANCH) | head -10
+
+# Interactive rebase for cleaning up commits
+sync-interactive:
+	@echo "üîß Starting interactive rebase..."
+	@git checkout $(AWG_BRANCH)
+	@git rebase -i $(UPSTREAM_BRANCH)
+
+# Show sync status and help
+sync-help:
+	@echo "Upstream Sync Commands:"
+	@echo ""
+	@echo "  make sync-setup      - Add upstream remote"
+	@echo "  make sync-check      - Check for new upstream commits"
+	@echo "  make export-patches  - Export AWG commits as patch files"
+	@echo "  make sync-upstream   - Update dev-next from upstream"
+	@echo "  make sync-rebase     - Rebase AWG branch onto dev-next"
+	@echo "  make sync-full       - Full sync (upstream + rebase)"
+	@echo "  make apply-patches   - Apply patches from backup"
+	@echo ""
+	@echo "Workflow:"
+	@echo "  1. make sync-check       # See what's new"
+	@echo "  2. make export-patches   # Backup your patches"
+	@echo "  3. make sync-full        # Sync and rebase"
+	@echo "  4. make build            # Verify build works"
+	@echo ""
-- 
2.52.0

